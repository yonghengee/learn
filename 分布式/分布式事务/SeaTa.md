Seata Alibaba
=====

Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。
Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。

# 事务模式

## AT模式
### 前提
基于支持本地ACID事务的关系性数据库  
java应用，通过jdbc进行数据库访问

### 整体机制  
两阶段提交协议的演变  
* 一阶段：业务数据和回滚日志在同一个本地事务中进行提交，释放本地锁和连接资源  
* 二阶段：  
** 提交异步化，非常快速完成。  
** 回滚一阶段的回滚日志进行反向补偿。 

### 写隔离
* 一阶段本地事务提交前，需要确保先拿到全局锁 。
* 拿不到 全局锁 ，不能提交本地事务。
* 拿全局锁的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁。

两个全局事务 tx1 和 tx2  
1，tx1开启本地事务，获取**本地锁**，进行业务逻辑，回滚日志逻辑记录 在提交本地事务之前，进行获取**全局锁**，获取成功则提交本地事务，释放 **本地锁**  
2，tx2开启本地事务，获取**本地锁**，进行业务逻辑，提交本地事务之前，尝试获取**全局锁**，tx1全局提交前，该记录的全局锁被tx1持有，tx2需要重试进行等待 **全局锁**
3，tx1二阶段提交全局事务，释放全局锁    
4，tx2获取到全局锁提交本地事务  

5，若tx1的二阶段进行回滚，则tx1需要重新获取该数据的**本地锁**，进行反向补充的更新操作，实现tx1业务的回滚  
6，此时tx2仍在等待该数据的**全局锁**，同时持有**本地锁**，则tx1获取不到**本地锁**，回滚失败，  
tx1会一直重试，直到tx2获取**全局锁**超时，放弃**全局锁**获取，并回滚本地事务释放本地锁，tx1回滚最终成功
 
 因为整个过程 全局锁 在 tx1 结束前一直是被 tx1 持有的，所以不会发生 脏写 的问题。
### 读隔离
在数据库本地事务隔离级别 **读已提交** 或以上基础之上，Seata（AT模式）的默认全局隔离级别是**读未提交**    
如果应用在特定场景下，必需要求全局的 读已提交 ，目前 Seata 的方式是通过 SELECT FOR UPDATE 语句的代理。  
  **SELECT FOR UPDATE**  会等待行锁释放之后，返回查询结果。
  **SELECT FOR UPDATE** 语句的执行会申请 全局锁 ，如果 全局锁 被其他事务持有，则释放本地锁（回滚 SELECT FOR UPDATE 语句的本地执行）并重试。这个过程中，查询是被 block 住的，直到 全局锁 拿到，即读取的相关数据是 已提交 的，才返回。  
出于总体性能上的考虑，Seata 目前的方案并没有对所有 SELECT 语句都进行代理，仅针对 FOR UPDATE 的 SELECT 语句。  

## TCC 模式
回顾总览中的描述：一个分布式的全局事务，整体是 两阶段提交 的模型。全局事务是由若干分支事务组成的，分支事务要满足 两阶段提交 的模型要求，即需要每个分支事务都具备自己的  
* 一阶段的prepare行为
* 二阶段的commit或rollback行为

根据两阶段行为模式的不同，我们将分支事务划分为 Automatic (Branch) Transaction Mode 和 Manual (Branch) Transaction Mode.

* AT 模式（参考链接 TBD）基于 支持本地 ACID 事务 的 关系型数据库：
一阶段 prepare 行为：在本地事务中，一并提交业务数据更新和相应回滚日志记录。  
二阶段 commit 行为：马上成功结束，自动 异步批量清理回滚日志。  
二阶段 rollback 行为：通过回滚日志，自动 生成补偿操作，完成数据回滚。  
* 相应的，TCC 模式，不依赖于底层数据资源的事务支持：  
一阶段 prepare 行为：调用 自定义 的 prepare 逻辑。   
二阶段 commit 行为：调用 自定义 的 commit 逻辑。   
二阶段 rollback 行为：调用 自定义 的 rollback 逻辑。  
**所谓 TCC 模式，是指支持把 自定义 的分支事务纳入到全局事务的管理中。**

## Saga模式
Sage是Seata提供长事务的解决方案Saga模式是SEATA提供的长事务解决方案，在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，
一阶段正向服务和二阶段补偿服务都由业务开发实现。  

**优势** ：
* 一阶段提交本地事务，无锁，高性能  
* 事件驱动架构，参与者可异步执行，高吞吐  
* 补偿服务易于实现  
